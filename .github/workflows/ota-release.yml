name: OTA Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ota-release:
    name: Build OTA Release Assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Configure - OTA Release (All Features)
        run: |
          cat sdkconfig.defaults sdkconfig.all-features > sdkconfig

      - name: Build firmware
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: release-v5.4
          target: esp32c6
          command: idf.py build

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp build/esp_watch.bin release/esp_watch.bin
          cp build/bootloader/bootloader.bin release/bootloader.bin
          cp build/partition_table/partition-table.bin release/partition-table.bin
          if [ -f build/flash_args ]; then
            cp build/flash_args release/flash_args
          fi
          python - <<'PY'
          import hashlib
          import json
          import os
          import pathlib

          bin_path = pathlib.Path("release/esp_watch.bin")
          data = bin_path.read_bytes()
          sha = hashlib.sha256(data).hexdigest()
          size = len(data)
          version = os.environ["GITHUB_REF_NAME"]
          repo = os.environ["GITHUB_REPOSITORY"]
          url = f"https://github.com/{repo}/releases/download/{version}/esp_watch.bin"

          manifest = {
              "version": version,
              "url": url,
              "sha256": sha,
              "size": size,
          }

          pathlib.Path("release/ota_release.json").write_text(json.dumps(manifest, indent=2) + "\n")
          pathlib.Path("release/esp_watch.bin.sha256").write_text(f"{sha}  esp_watch.bin\n")
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release/esp_watch.bin
            release/bootloader.bin
            release/partition-table.bin
            release/flash_args
            release/ota_release.json
            release/esp_watch.bin.sha256
